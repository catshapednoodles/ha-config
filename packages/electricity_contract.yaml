electricity_contract_package:
  template:
    - sensor:
        - name: "Energy usage since start contract"
          unique_id: 6f1f783d-6437-4cec-a6d1-782119c2b1fd
          unit_of_measurement: kWh
          state_class: total
          device_class: energy
          icon: mdi:home-import-outline
          state: >
            {% set start1 = 4791.932 %}
            {% set start2 = 2175.834 %}
            {% set current_merged = states('sensor.dsmr_reading_electricity_delivered_1') | float(0) + states('sensor.dsmr_reading_electricity_delivered_2') | float(0) %}
            {{ (current_merged - start1 - start2) | round(2) }}
          availability: >
            {{ states('sensor.dsmr_reading_electricity_delivered_1') | is_number and states('sensor.dsmr_reading_electricity_delivered_2') | is_number }}
          attributes:
            start_contract: "{{ '2024-10-01' | as_datetime }}"
        - name: "Energy return since start contract"
          unique_id: dba6c39a-47ee-4976-b3ab-2149cce2e323
          unit_of_measurement: kWh
          state_class: total
          device_class: energy
          icon: mdi:home-export-outline
          state: >
            {% set start1 = 1841.328 %}
            {% set start2 = 4666.630 %}
            {% set current_merged = states('sensor.dsmr_reading_electricity_returned_1') | float(0) + states('sensor.dsmr_reading_electricity_returned_2') | float(0) %}
            {{ (current_merged - start1 - start2) | round(2) }}
          availability: >
            {{ states('sensor.dsmr_reading_electricity_returned_1') | is_number and states('sensor.dsmr_reading_electricity_returned_2') | is_number }}
          attributes:
            start_contract: "{{ '2024-10-01' | as_datetime }}"
        - name: "Difference between usage and return since start contract"
          unique_id: difference_usage_return_since_start_contract
          unit_of_measurement: kWh
          icon: mdi:arrow-left-right
          state: >
            {{ (states('sensor.energy_usage_since_start_contract') | float(0) - states('sensor.energy_return_since_start_contract') | float(0)) | round(1) }}
          availability: >
            {{ states('sensor.energy_usage_since_start_contract') | is_number and states('sensor.energy_return_since_start_contract') | is_number }}

  automation:
    - alias: "Energy contract: Switch contracts?"
      id: 88d23a95-b254-469f-9a65-c8c6499c4272
      mode: single
      trigger:
        - platform: state
          entity_id: binary_sensor.energy_tax_included_this_year
          from: "on"
          to: "off"
        - platform: numeric_state
          entity_id: sensor.difference_between_usage_and_return_since_start_contract
          below: 200
          for: "00:00:10"
      action:
        - service: notify.sicco_phone
          data:
            title: Energy contract - Salderingsruimte gone soon
            message: >
              Now might be a good time to consider switching contracts!
              Based on: {{ trigger.to_state.name }}
            data:
              notification_icon: "mdi:file-document-edit"
