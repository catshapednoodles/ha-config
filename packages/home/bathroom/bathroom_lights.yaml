bathroom_lights_package:
  adaptive_lighting:
    - name: "Bathroom"
      lights:
        - light.bathroom_lights
      min_brightness: 65
      max_brightness: 90
      autoreset_control_seconds: 3600
      detect_non_ha_changes: true
      max_sunrise_time: "09:00:00"
      separate_turn_on_commands: true
      skip_redundant_commands: true

  binary_sensor:
    - platform: threshold
      name: Bathroom is dark
      entity_id: sensor.bathroom_motion_sensor_illuminance
      lower: 100
      hysteresis: 75

  input_boolean:
    automatic_bathroom_lights:
      name: Automatic bathroom lights
      icon: mdi:lightbulb-auto
    bathroom_lights_manually_switched_on:
      name: Bathroom lights manually switched on
      icon: mdi:light-switch

  input_number:
    bathroom_lights_time_on:
      name: Bathroom lights time on
      icon: mdi:clock-start
      min: 1
      max: 30
      mode: box

  template:
    - binary_sensor:
        - name: "Activity in Bathroom"
          unique_id: activity_in_bathroom
          device_class: occupancy
          state: >
            {{ is_state("binary_sensor.bathroom_motion_sensor_occupancy", "on")
              or (is_state('sensor.smart_series_6000_9426_toothbrush_state', 'running')
                and not is_state_attr('sensor.smart_series_6000_9426_toothbrush_state', 'assumed_state', True)) }}

  automation:
    - alias: "Bathroom: Toggle lights on motion"
      id: b88444fd-f079-4658-8a55-b72b894d06cb
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.activity_in_bathroom
        - platform: state
          entity_id: binary_sensor.activity_in_bathroom
          to: "off"
          for:
            minutes: >
              {% set extra_time = 45 if is_state('input_boolean.bathroom_lights_manually_switched_on', 'on') else 0 %}
              {{ states('input_number.bathroom_lights_time_on')|int(1) + extra_time }}
        - platform: state
          entity_id: binary_sensor.bathroom_is_dark
        - platform: state
          entity_id: binary_sensor.sun_low_elevation
        - platform: state
          entity_id: input_boolean.automatic_bathroom_lights
          to: "on"
      condition:
        - condition: state
          entity_id: input_boolean.automatic_bathroom_lights
          state: "on"
      action:
        - choose:
            # Turn on light if there's activity and sun is low or it is dark
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_bathroom
                  state: "on"
                - or:
                    - condition: state
                      entity_id: binary_sensor.sun_low_elevation
                      state: "on"
                    - condition: state
                      entity_id: binary_sensor.bathroom_is_dark
                      state: "on"
              sequence:
                - service: light.turn_on
                  data:
                    entity_id:
                      - light.bathroom_lights
            # Turn off lights when there's no activity
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_bathroom
                  state: "off"
                  for:
                    minutes: >
                      {% set extra_time = 45 if is_state('input_boolean.bathroom_lights_manually_switched_on', 'on') else 0 %}
                      {{ states('input_number.bathroom_lights_time_on')|int(1) + extra_time }}
              sequence:
                - service: light.turn_off
                  data:
                    entity_id:
                      - light.bathroom_lights
            - conditions:
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "off"
                - condition: state
                  entity_id: binary_sensor.bathroom_is_dark
                  state: "off"
                - condition: state
                  entity_id: input_boolean.bathroom_lights_manually_switched_on
                  state: "off"
              sequence:
                - service: light.turn_off
                  data:
                    entity_id:
                      - light.bathroom_lights

    - alias: "Bathroom: Turn off switch helper"
      id: 4e6db72b-a84c-4908-bb67-495aa32e33d6
      mode: queued
      trigger:
        - platform: state
          entity_id: light.bathroom_ceiling
          to: "off"
      action:
        - service: input_boolean.turn_off
          entity_id: input_boolean.bathroom_lights_manually_switched_on

    - alias: "Bathroom: Reset automatic boolean helper"
      id: 10e4e3d9-fe52-4fe6-8e41-adb555e824f2
      trigger:
        - platform: state
          entity_id: input_boolean.automatic_bathroom_lights
          to: "off"
          for:
            hours: 2
      action:
        - service: input_boolean.turn_on
          entity_id: input_boolean.automatic_bathroom_lights

    - alias: "Bathroom: Light switch"
      id: 84fe8d75-a5b8-4749-be2a-7ea653a20ae7
      description: ""
      use_blueprint:
        path: chris-1243/PTM_215Z_ZE.yaml
        input:
          hold_delay: 300
          controller: Bathroom Switch
          button_1_pressed:
            - service: light.turn_on
              data: {}
              target:
                entity_id: light.bathroom_mirror
            - service: input_boolean.turn_on
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_1_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Mirror/set
                payload: '{"brightness_move_onoff": 85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_1_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Mirror/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_2_pressed:
            - service: light.turn_off
              data: {}
              target:
                entity_id: light.bathroom_mirror
            - service: input_boolean.turn_off
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_2_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Mirror/set
                payload: '{"brightness_move_onoff": -85}'
                qos: 0
                retain: false
          button_2_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Mirror/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_3_pressed:
            - service: light.turn_on
              data: {}
              target:
                entity_id: light.bathroom_ceiling
            - service: input_boolean.turn_on
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_3_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Ceiling/set
                payload: '{"brightness_move_onoff": 85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_3_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Ceiling/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_4_pressed:
            - service: light.turn_off
              data: {}
              target:
                entity_id: light.bathroom_ceiling
            - service: input_boolean.turn_off
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_4_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Ceiling/set
                payload: '{"brightness_move_onoff": -85}'
                qos: 0
                retain: false
          button_4_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Bathroom Ceiling/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_1_and_3_pressed:
            - service: light.turn_on
              data: {}
              target:
                entity_id:
                  - light.bathroom_mirror
                  - light.bathroom_ceiling
            - service: input_boolean.turn_on
              entity_id: input_boolean.bathroom_lights_manually_switched_on
          button_2_and_4_pressed:
            - service: light.turn_off
              data: {}
              target:
                entity_id:
                  - light.bathroom_mirror
                  - light.bathroom_ceiling
            - service: input_boolean.turn_off
              entity_id: input_boolean.bathroom_lights_manually_switched_on
