central_heating_package:
  climate:
    - platform: generic_thermostat
      name: Master thermostat
      heater: input_boolean.heating_active
      target_sensor: sensor.master_temperature_minimum
      min_temp: 15
      max_temp: 25
      cold_tolerance: 0.3
      hot_tolerance: 0.3
      min_cycle_duration:
        hours: 1
      precision: 0.1

  input_boolean:
    heating_active:
      name: Heating active
      icon: mdi:heating-coil
    heat_pump_variable_water_temperature:
      name: Heat pump variable water temperature
      icon: mdi:heating-coil

  input_number:
    thermostat_temperature_setpoint:
      name: "Thermostat temperature setpoint"
      icon: mdi:thermometer-auto
      min: 15
      max: 25
      mode: box
      step: 0.5
      unit_of_measurement: "째C"
    thermostat_temperature_variance:
      name: "Thermostat temperature variance"
      icon: mdi:thermometer-plus
      min: 0
      max: 2
      mode: box
      step: 0.5
      unit_of_measurement: "째C"
    water_temperature_setpoint:
      name: "Water temperature setpoint"
      icon: mdi:thermometer-water
      min: 20
      max: 30
      mode: box
      step: 0.5
      unit_of_measurement: "째C"
    water_temperature_variance:
      name: "Water temperature variance"
      icon: mdi:thermometer-plus
      min: 0
      max: 10
      mode: box
      step: 0.5
      unit_of_measurement: "째C"

  sensor:
    - platform: min_max
      unique_id: 35269488-5754-4fd2-aeeb-eabe7194964c
      name: Master temperature
      type: median
      round_digits: 1
      entity_ids:
        - sensor.kitchen_temperature
        - sensor.living_room_temperature
    - platform: min_max
      unique_id: a22b2f10-97d4-4464-8e7f-c706cb35d165
      name: Master temperature whole house
      type: median
      round_digits: 1
      entity_ids:
        - sensor.kitchen_temperature
        - sensor.living_room_temperature
        - sensor.office_temperature
        - sensor.bedroom_temperature
        - sensor.game_room_temperature
    - platform: min_max
      unique_id: 69976f40-bb5b-4920-bb7c-918a9111a12d
      name: Master temperature minimum
      type: min
      round_digits: 1
      entity_ids:
        - sensor.master_temperature
        - sensor.master_temperature_whole_house
        - sensor.living_room_temperature

    # https://gathering.tweakers.net/forum/list_message/73381860#73381860
    - platform: nordpool_diff
      nordpool_entity: sensor.day_ahead_price
      filter_length: 10
      filter_type: rectangle
      normalize: max_min

  switch:
    - platform: template
      switches:
        heat_pump_heating:
          friendly_name: "Heat pump heating"
          unique_id: 98e11bbe-a3da-4000-90eb-10c6a3951e74
          value_template: "{{ is_state('switch.mitsubishi_system_on_off', 'on') and is_state('switch.mitsubishi_set_holiday_mode', 'off') and is_state('select.mitsubishi_hc_control_type', 'Heating') }}"
          availability_template: "{{ True }}"
          icon_template: "{{ 'mdi:heat-pump' if this.state == 'on' else 'mdi:heat-pump-outline' }}"
          turn_on:
            - service: switch.turn_on
              target:
                entity_id: switch.mitsubishi_system_on_off
            - service: select.select_option
              target:
                entity_id: select.mitsubishi_hc_control_type
              data:
                option: Heating
            - service: switch.turn_off
              target:
                entity_id: switch.mitsubishi_set_holiday_mode
          turn_off:
            - service: switch.turn_on
              target:
                entity_id: switch.mitsubishi_set_holiday_mode

  template:
    - trigger:
        - platform: numeric_state
          entity_id: weather.combined
          attribute: temperature
          above: 5
          for: "00:30:00"
        - platform: numeric_state
          entity_id: weather.combined
          attribute: temperature
          below: 3
          for: "00:30:00"
      binary_sensor:
      - name: Low temperature outside
        unique_id: 821eccf5-89de-4c48-bd5b-86ff275a4ed5
        device_class: cold
        state: >
          {{ state_attr('weather.combined', 'temperature') < 5 }}
    - sensor:
        - name: "Heat Pump upcoming hours diff"
          unique_id: 64c8271e-1448-4fb6-99e1-c2e30d4e372e
          icon: mdi:flash
          unit_of_measurement: ""
          state: >
            {% set hours_considered = 1 * 4 %}
            {% set tomorrow = (now() + timedelta(days=1)).strftime('%Y-%m-%d') %}
            {% set x = (state_attr('sensor.day_ahead_price', 'raw_today') | selectattr('start', '>', now() - timedelta(minutes=15)) | map(attribute='value') | list)[:100]
            + (state_attr('sensor.day_ahead_price', 'raw_tomorrow') | selectattr('start', 'match', tomorrow) | map(attribute='value') | list)[:100] %}
            {% set range = (x | max - x | min) | round(6) %}
            {% if is_state('sensor.mitsubishi_operating_mode', 'Heating') and x[0] == x[0:hours_considered] | min %}
              {{ ((x[0] - x[1:40] | average) / range * -1.1) | round(6) }}
            {% elif is_state_attr('climate.master_thermostat', 'hvac_action', 'idle') and x[0] == x[0:hours_considered] | max %}
              {{ ((x[0] - x[1:40] | average) / range * -1) | round(6) }}
            {% else %}
              {{ ((x[0:hours_considered] | average - x[hours_considered:40] | average) / range * -1) | round(5) }}
            {% endif %}

  automation:
    - alias: "Heat pump: Set thermostat temperature"
      id: bb4f4038-0965-41c9-87c7-ca6e9f6f69c6
      mode: queued
      trigger:
        # - platform: state
        #   entity_id: sensor.nordpool_diff_rectangle_10_normalize_max_min
        #   for:
        #     seconds: 1
        - platform: state
          entity_id: sensor.heat_pump_upcoming_hours_diff
          for:
            seconds: 1
      condition:
        - condition: state
          entity_id: select.mitsubishi_hc_control_type
          state: "Heating"
        - "{{ has_value('sensor.day_ahead_price') }}"
      action:
        - parallel:
          # - service: climate.set_temperature
          #   target:
          #     entity_id: climate.master_thermostat
          #   data:
          #     temperature: >
          #       {% set temp_setpoint = states('input_number.thermostat_temperature_setpoint') | float(20.5) %}
          #       {% set variance = states('input_number.thermostat_temperature_variance') | float(0.5) %}
          #       {% set temperature_offset = 0.2 if is_state('binary_sensor.low_temperature_outside', 'on') and is_state('binary_sensor.sun_low_elevation_outside', 'on') else 0 %}
          #       {{ (temp_setpoint - temperature_offset + states('sensor.nordpool_diff_rectangle_10_normalize_max_min') | float(0) * variance) | round(1) if is_state('binary_sensor.negative_electricity_price_this_hour', 'off') else 21 }}
          - service: climate.set_temperature
            target:
              entity_id: climate.master_thermostat
            data:
              temperature: >
                {% set temp_setpoint = states('input_number.thermostat_temperature_setpoint') | float(20.5) %}
                {% set variance = states('input_number.thermostat_temperature_variance') | float(0.5) %}
                {% set temperature_offset = 0.2 if is_state('binary_sensor.low_temperature_outside', 'on') and is_state('binary_sensor.sun_low_elevation_outside', 'on') else 0 %}
                {{ (temp_setpoint - temperature_offset + states('sensor.heat_pump_upcoming_hours_diff') | float(0) * variance) | round(1) if is_state('binary_sensor.negative_electricity_price_this_hour', 'off') else 21 }}
          - if:
              - condition: state
                entity_id: input_boolean.heat_pump_variable_water_temperature
                state: "on"
            then:
              - service: number.set_value
                target:
                  entity_id: number.mitsubishi_h_c_thermostat_target_temperature
                data:
                  value: >
                    {% set temp_setpoint = states('input_number.water_temperature_setpoint') | float(25) %}
                    {% set variance = states('input_number.water_temperature_variance') | float(3) %}
                    {% set irradiance_offset = 0.5 if is_state('binary_sensor.sun_low_elevation_outside', 'on') else 0 %}
                    {% if state_attr('weather.combined', 'temperature') < 0 %}
                      {% set temperature_offset = 1 %}
                    {% elif state_attr('weather.combined', 'temperature') < 4 %}
                      {% set temperature_offset = 0.5 %}
                    {% else %}
                      {% set temperature_offset = 0 %}
                    {% endif %}
                    {{ (temp_setpoint - irradiance_offset + temperature_offset + states('sensor.nordpool_diff_rectangle_10_normalize_max_min') | float(0) * variance) | round(1, 'half') if is_state('binary_sensor.negative_electricity_price_this_hour', 'off') else 28 }}

    - alias: "Heat pump: Toggle heating"
      id: 2d192b97-7726-4e2b-8e5c-e8463c7df4e1
      mode: queued
      trigger:
        - platform: state
          entity_id: input_boolean.heating_active
      condition:
        - condition: state
          entity_id: select.mitsubishi_hc_control_type
          state: "Heating"
      action:
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.vacation_mode
                  state: "on"
                - condition: state
                  entity_id: input_boolean.vacation_mode_coming_home
                  state: "off"
                - condition: state
                  entity_id: binary_sensor.negative_electricity_price_this_hour
                  state: "off"
              sequence:
                - service: switch.turn_off
                  data:
                    entity_id: switch.heat_pump_heating
            - conditions:
                - condition: state
                  entity_id: input_boolean.heating_active
                  state: "on"
              sequence:
                - service: switch.turn_on
                  data:
                    entity_id: switch.heat_pump_heating
          default:
            - service: switch.turn_off
              data:
                entity_id: switch.heat_pump_heating
