vacation_mode_package:
  sensor:
    - platform: history_stats
      name: "replay_bathroom_ceiling"
      entity_id: light.bathroom_ceiling
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_ellens_room_ceiling"
      entity_id: light.ellens_room_ceiling
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_entryway_ceiling"
      entity_id: light.entryway_ceiling
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_game_room_wall_lamp"
      entity_id: light.game_room_wall_lamp
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_game_room_monitor"
      entity_id: light.game_room_monitor
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_game_room_shelf"
      entity_id: light.game_room_shelf
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_kitchen_ceiling"
      entity_id: light.kitchen_ceiling
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_kitchen_dining_light"
      entity_id: light.kitchen_dining_light
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_living_room_ceiling"
      entity_id: light.living_room_ceiling
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_living_room_corner"
      entity_id: light.living_room_corner
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_office_ceiling"
      entity_id: light.office_ceiling
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30
    - platform: history_stats
      name: "replay_living_room_cozy"
      entity_id: light.living_room_cozy
      state: "on"
      type: count
      start: >
        {{ as_timestamp(now()) - (7*86400) }}
      duration: 00:00:30

  automation:
    - alias: 'Vacation: Replay lighting from 7 days ago'
      id: 3da83415-9e36-402d-bf97-28947375910c
      mode: queued
      trigger:
        - platform: state
          entity_id:
            - sensor.replay_bathroom_ceiling
            - sensor.replay_ellens_room_ceiling
            - sensor.replay_entryway_ceiling
            - sensor.replay_game_room_wall_lamp
            - sensor.replay_game_room_monitor
            - sensor.replay_game_room_shelf
            - sensor.replay_kitchen_ceiling
            - sensor.replay_kitchen_dining_light
            - sensor.replay_living_room_ceiling
            - sensor.replay_living_room_corner
            - sensor.replay_office_ceiling
            - sensor.replay_living_room_cozy
      condition:
        - condition: state
          entity_id: input_boolean.vacation_mode_short_trip
          state: 'on'
      action:
        - variables:
            corresponding_light: >
              {% set lights = {
                'sensor.replay_bathroom_ceiling': 'light.bathroom_ceiling',
                'sensor.replay_ellens_room_ceiling': 'light.ellens_room_ceiling',
                'sensor.replay_entryway_ceiling': 'light.entryway_ceiling',
                'sensor.replay_game_room_wall_lamp': 'light.game_room_wall_lamp',
                'sensor.replay_game_room_monitor': 'light.game_room_monitor',
                'sensor.replay_game_room_shelf': 'light.game_room_shelf',
                'sensor.replay_kitchen_ceiling': 'light.kitchen_ceiling',
                'sensor.replay_kitchen_dining_light': 'light.kitchen_dining_light',
                'sensor.replay_living_room_ceiling': 'light.living_room_ceiling',
                'sensor.replay_living_room_corner': 'light.living_room_corner',
                'sensor.replay_office_ceiling': 'light.office_ceiling',
                'sensor.replay_living_room_cozy': 'light.living_room_cozy',
              } %}
              {{ lights[trigger.entity_id] }}
        - choose:
            # Replay turned on
            - conditions:
                - condition: template
                  value_template: '{{ trigger.to_state.state == "1" }}'
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: '{{ corresponding_light }}'
                - service: system_log.write
                  data:
                    message: 'Replay Lighting: {{trigger.to_state.entity_id}}: turning on: {{ corresponding_light }}'
                    level: info
            # Replay turned off
            - conditions:
                - condition: template
                  value_template: '{{ trigger.to_state.state == "0" }}'
              sequence:
                - service: light.turn_off
                  data:
                    entity_id: '{{ corresponding_light }}'
                - service: system_log.write
                  data:
                    message: 'Replay Lighting: {{trigger.to_state.entity_id}}: turning off:{{ corresponding_light }}'
                    level: info

    - alias: 'Vacation: Automate curtains'
      id: 6b93bf24-74a6-4bdd-a06f-10e1c9eab15c
      mode: queued
      trigger:
        - platform: time
          at: "23:45:00"
          id: close_curtains
        - platform: time
          at: "07:35:00"
          id: open_curtains
      condition:
        - condition: state
          entity_id: input_boolean.vacation_mode
          state: 'on'
      action:
        - delay:
            seconds: "{{ range(0, 1800)|random|int }}"
        - choose:
            - conditions:
                - condition: trigger
                  id: open_curtains
              sequence:
                - service: cover.close_cover
                  data:
                    entity_id: cover.living_room_curtains_tahoma
                - service: button.press
                  entity_id: button.kitchen_curtains_tahoma_my_position
                - service: system_log.write
                  data:
                    message: 'Vacation mode: Opened the curtains'
                    level: info
            - conditions:
                - condition: trigger
                  id: close_curtains
              sequence:
                - service: button.press
                  entity_id: button.living_room_curtains_tahoma_my_position
                - service: cover.open_cover
                  data:
                    entity_id: cover.kitchen_curtains_tahoma
                - service: system_log.write
                  data:
                    message: 'Vacation mode: Closed the curtains'
                    level: info

    - alias: 'Vacation: Skip Sint-Maarten'
      id: 59b9cbe1-023c-4c89-90f8-d3fba75d8856
      mode: queued
      triggers:
        - platform: time
          at: "17:00:00"
          id: start
        - platform: time
          at: "20:45:00"
          id: end
      conditions:
        - condition: state
          entity_id: input_boolean.vacation_mode
          state: 'on'
        - condition: template
          value_template: "{{ now().day == 11 and now().month == 11 }}"
      actions:
        - delay:
            seconds: "{{ range(0, 900)|random|int }}"
        - choose:
            - conditions:
                - condition: trigger
                  id: start
              sequence:
                - service: input_boolean.turn_off
                  entity_id: input_boolean.vacation_mode_short_trip
                - service: light.turn_off
                  entity_id: light.inside_lights
            - conditions:
                - condition: trigger
                  id: end
              sequence:
                - service: input_boolean.turn_on
                  entity_id: input_boolean.vacation_mode_short_trip
                - service: script.turn_on
                  target:
                    entity_id: script.restore_vacation_lights_after_guest_leaves

  script:
    restore_vacation_lights_after_guest_leaves:
      alias: Restore vacation lights after guest leaves
      sequence:
        - if:
            - condition: state
              entity_id: sensor.replay_bathroom_ceiling
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.bathroom_ceiling
        - if:
            - condition: state
              entity_id: sensor.replay_ellens_room_ceiling
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.ellens_room_ceiling
        - if:
            - condition: state
              entity_id: sensor.replay_entryway_ceiling
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.entryway_ceiling
        - if:
            - condition: state
              entity_id: sensor.replay_game_room_monitor
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.game_room_monitor
        - if:
            - condition: state
              entity_id: sensor.replay_game_room_shelf
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.game_room_shelf
        - if:
            - condition: state
              entity_id: sensor.replay_game_room_wall_lamp
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.game_room_wall_lamp
        - if:
            - condition: state
              entity_id: sensor.replay_kitchen_ceiling
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.kitchen_ceiling
        - if:
            - condition: state
              entity_id: sensor.replay_kitchen_dining_light
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.kitchen_dining_light
        - if:
            - condition: state
              entity_id: sensor.replay_living_room_ceiling
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.living_room_ceiling
        - if:
            - condition: state
              entity_id: sensor.replay_living_room_corner
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.living_room_corner
        - if:
            - condition: state
              entity_id: sensor.replay_office_ceiling
              state: "1"
          then:
            - service: light.turn_on
              data:
                entity_id: light.office_ceiling
      mode: restart
