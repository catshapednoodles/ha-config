central_ventilation_package:
  binary_sensor:
  - platform: generic_hygrostat
    name: Bathroom Hygrostat
    sensor: sensor.bathroom_humidity # Source humidity sensor
    delta_trigger: 5 # Optional humidity swing to detect. Default = 3
    target_offset: 10 # Optional dehumidification target offset. Default = 3
    min_on_time: 1200 # Optional min on time in seconds. Default = 0 seconds
    max_on_time: 3600 # Optional safety max on time in seconds. Default = 7200 seconds
    sample_interval: 240 # Optional time between taking humidity samples in seconds, default 300 seconds
    min_humidity: 30 # Optional minimum humidity to enable dehumidification. Default = 0
    unique_id: bathroom_hygrostat # Optional ID that uniquely identifies this sensor. Set this to a unique value to allow customization through the UI.

  input_boolean:
    ventilation_on_full_during_sleep:
      name: Ventilation on full during sleep
      icon: mdi:fan-chevron-up

  input_number:
    co2_threshold:
      name: "CO2 threshold"
      icon: "mdi:molecule-co2"
      min: 800
      max: 1500
      mode: slider
      step: 100
    tvoc_threshold:
      name: "TVOC threshold"
      icon: "mdi:molecule"
      min: 300
      max: 1500
      mode: slider
      step: 100
    pm2_5_threshold:
      name: "PM2.5 threshold"
      icon: "mdi:molecule"
      min: 15
      max: 55
      mode: slider
      step: 5

  template:
    - binary_sensor:
        - name: "CO2 above threshold"
          unique_id: "co2_above_threshold"
          state: "{{ states('sensor.kitchen_carbon_dioxide') | float(0) >= states('input_number.co2_threshold') | float(1) }}"
          delay_off: "00:15:00"
          device_class: gas
        - name: "TVOC above threshold"
          unique_id: "tvoc_above_threshold"
          state: "{{ states('sensor.sensor.kitchen_vocs') | float(0) >= states('input_number.tvoc_threshold') | float(1) }}"
          delay_off: "00:15:00"
          device_class: gas
        - name: "PM2.5 above threshold"
          unique_id: "pm2_5_above_threshold"
          state: "{{ states('sensor.kitchen_pm2_5') | float(0) >= states('input_number.pm2_5_threshold') | float(1) }}"
          delay_off: "00:15:00"
          device_class: gas
        - name: "High humidity at home"
          unique_id: "high_humidity_at_home"
          state: >
            {% set cutoff = 67 %}
            {% set outside_humidity = state_attr('weather.combined', 'humidity') - 4 %}
            {{
              states.sensor
                | select('search', '_humidity')
                | reject('search', 'bathroom')
                | rejectattr('state', 'eq', 'unavailable')
                | rejectattr('state', 'eq', 'unknown')
                | selectattr('attributes.unit_of_measurement', 'eq', '%')
                | selectattr('state', '>', cutoff|string)
                | selectattr('state', '>', outside_humidity|string)
                | list
                | count > 0
            }}
          device_class: moisture
        - name: "Medium high humidity at home"
          unique_id: "medium_high_humidity_at_home"
          state: >
            {% set cutoff = 55 %}
            {% set outside_humidity = state_attr('weather.combined', 'humidity') - 2 %}
            {{
              states.sensor
                | select('search', '_humidity')
                | reject('search', 'bathroom')
                | rejectattr('state', 'eq', 'unavailable')
                | rejectattr('state', 'eq', 'unknown')
                | selectattr('attributes.unit_of_measurement', 'eq', '%')
                | selectattr('state', '>', cutoff|string)
                | selectattr('state', '>', outside_humidity|string)
                | list
                | count > 0
            }}
          device_class: moisture
        - name: "CO2 high in kitchen"
          unique_id: "co2_high_in_kitchen"
          state: "{{ states('sensor.kitchen_carbon_dioxide') | float(0) >= 600 }}"
          delay_off: "00:15:00"
          device_class: gas
        - name: "CO2 high in bedroom"
          unique_id: "co2_high_in_bedroom"
          state: "{{ states('sensor.bedroom_carbon_dioxide') | float(0) >= 700 }}"
          delay_off: "00:15:00"
          device_class: gas
        - name: "CO2 very high in bedroom"
          unique_id: "co2_very_high_in_bedroom"
          state: "{{ states('sensor.bedroom_carbon_dioxide') | float(0) >= 1000 }}"
          delay_off: "00:15:00"
          device_class: gas
    - sensor:
        - name: "ESP-WTW Ventilation Percentage"
          unique_id: esp_wtw_ventilation_percentage
          unit_of_measurement: "%"
          state: "{{ state_attr('fan.esp_wtw_ventilation', 'percentage') }}"
        - name: "WTW Ventilation Percentage"
          unique_id: wtw_ventilation_percentage
          unit_of_measurement: "%"
          state: "{{ state_attr('fan.wtw_ventilation', 'percentage') }}"

  automation:
    - alias: "Central Ventilation: Control ventilation modes"
      id: 1c6823df-301e-47da-b8f1-6334d8f67a80
      mode: queued
      trigger:
        - platform: state
          entity_id: input_boolean.sleep_mode
        - platform: state
          entity_id: input_boolean.someone_is_sleeping
        - platform: state
          entity_id: input_boolean.sicco_is_sleeping
          to: "on"
          for: "00:30:00"
        - platform: state
          entity_id: binary_sensor.co2_above_threshold
        - platform: state
          entity_id: binary_sensor.tvoc_above_threshold
        - platform: state
          entity_id: binary_sensor.pm2_5_above_threshold
        - platform: state
          entity_id: binary_sensor.bathroom_hygrostat
        - platform: state
          entity_id: binary_sensor.medium_high_humidity_at_home
        - platform: state
          entity_id: binary_sensor.high_humidity_at_home
        - platform: state
          entity_id: binary_sensor.co2_high_in_kitchen
        - platform: state
          entity_id: binary_sensor.co2_high_in_bedroom
        - platform: state
          entity_id: binary_sensor.co2_very_high_in_bedroom
        - platform: state
          entity_id: input_boolean.wtw_smelly_air_outside
        - platform: time
          at: "06:00:00"
      action:
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.wtw_smelly_air_outside
                  state: "on"
              sequence:
                - service: fan.set_percentage
                  data:
                    percentage: 10
                  target:
                    entity_id: fan.wtw_ventilation
            - conditions:
                - condition: state
                  entity_id: input_boolean.ventilation_on_full_during_sleep
                  state: "on"
                - condition: state
                  entity_id: input_boolean.sicco_is_sleeping
                  state: "on"
                  for: "01:30:00"
                - condition: state
                  entity_id: binary_sensor.co2_very_high_in_bedroom
                  state: "on"
                - condition: time
                  before: "06:00:00"
              sequence:
                - service: fan.set_percentage
                  data:
                    percentage: 100
                  target:
                    entity_id: fan.wtw_ventilation
            - conditions:
                - condition: state
                  entity_id: input_boolean.sicco_is_sleeping
                  state: "on"
                  for: "00:30:00"
                - condition: state
                  entity_id: binary_sensor.co2_high_in_bedroom
                  state: "on"
              sequence:
                - service: fan.set_percentage
                  data:
                    percentage: 66
                  target:
                    entity_id: fan.wtw_ventilation
            - conditions:
                or:
                  - condition: state
                    entity_id: input_boolean.sicco_is_sleeping
                    state: "on"
                  - condition: state
                    entity_id: input_boolean.sleep_mode
                    state: "on"
              sequence:
                - service: fan.set_percentage
                  data:
                    percentage: 33
                  target:
                    entity_id: fan.wtw_ventilation
            - conditions:
                or:
                - condition: state
                  entity_id: binary_sensor.co2_above_threshold
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.tvoc_above_threshold
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.pm2_5_above_threshold
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.bathroom_hygrostat
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.high_humidity_at_home
                  state: "on"
              sequence:
                - service: fan.set_percentage
                  data:
                    percentage: 100
                  target:
                    entity_id: fan.wtw_ventilation
            - conditions:
                or:
                - condition: state
                  entity_id: binary_sensor.medium_high_humidity_at_home
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.co2_high_in_kitchen
                  state: "on"
              sequence:
                - service: fan.set_percentage
                  data:
                    percentage: 66
                  target:
                    entity_id: fan.wtw_ventilation
          default:
            - service: fan.set_percentage
              data:
                percentage: 33
              target:
                entity_id: fan.wtw_ventilation