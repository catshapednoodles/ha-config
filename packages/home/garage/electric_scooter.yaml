electric_scooter_package:
  binary_sensor:
    - platform: nordpool_planner
      nordpool_entity: sensor.nordpool_kwh_nl_eur_3_09_0
      entity_id: charge_electric_scooter
      duration: 5
      moving:
        search_length: 24

  input_boolean:
    electric_scooter_should_charge:
      name: Electric scooter should charge
      icon: mdi:moped-electric

  mqtt:
    - button:
        name: "E-Scooter charger status update"
        command_topic: "shellyplusplugs-b0b21c18db24/command/switch:0"
        payload_press: "status_update"

    - sensor:
      - name: "E-Scooter charger power"
        state_topic: "shellyplusplugs-b0b21c18db24/status/switch:0"
        unit_of_measurement: "W"
        value_template: "{{ value_json.apower | round(1) }}"
        # availability:
        #   - topic: "shellyplusplugs-b0b21c18db24/online"
        # payload_available: "true"
        # payload_not_available: "false"
      - name: "E-Scooter charger voltage"
        state_topic: "shellyplusplugs-b0b21c18db24/status/switch:0"
        unit_of_measurement: "V"
        value_template: "{{ value_json.voltage | round(1) }}"
        # availability:
        #   - topic: "shellyplusplugs-b0b21c18db24/online"
        # payload_available: "true"
        # payload_not_available: "false"
      - name: "E-Scooter charger current"
        state_topic: "shellyplusplugs-b0b21c18db24/status/switch:0"
        unit_of_measurement: "A"
        value_template: "{{ value_json.current | round(1) }}"
        # availability:
        #   - topic: "shellyplusplugs-b0b21c18db24/online"
        # payload_available: "true"
        # payload_not_available: "false"

  automation:
    - alias: "E-scooter: Charge at cheap hours"
      id: cf6587be-9dce-49e6-aecf-1ab02ec48c4f
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.nordpool_planner_charge_electric_scooter
        - platform: state
          entity_id: device_tracker.iva_nce
          from: "home"
        - platform: state
          entity_id: device_tracker.iva_nce
          to: "home"
          for: "00:05:00"
        - platform: state
          entity_id: input_boolean.electric_scooter_should_charge
      action:
        - choose:
            - conditions:
                - condition: state
                  entity_id: binary_sensor.nordpool_planner_charge_electric_scooter
                  state: "on"
                - condition: state
                  entity_id: input_boolean.electric_scooter_should_charge
                  state: "on"
                - condition: state
                  entity_id: device_tracker.iva_nce
                  state: "home"
                  for: "00:05:00"
              sequence:
                - service: switch.turn_on
                  data:
                    entity_id: switch.e_scooter_switch
          default:
            - service: switch.turn_off
              data:
                entity_id: switch.e_scooter_switch
