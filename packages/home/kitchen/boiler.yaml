boiler_package:
  binary_sensor:
    - platform: nordpool_planner
      nordpool_entity: sensor.nordpool_kwh_nl_eur_3_09_0
      entity_id: next_hour_is_more_expensive
      duration: 1
      moving:
        search_length: 2

  automation:
    - alias: "Boiler: Stop heating up on most expensive hours"
      id: 5416039b-0d69-4501-9ba6-fef7c9e49069
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.electricity_most_expensive_2_hours
        - platform: state
          entity_id: binary_sensor.electricity_most_expensive_2_hours
          to: "on"
          for: "01:00:01"
      action:
        - choose:
            - conditions:
                - condition: state
                  entity_id: binary_sensor.electricity_most_expensive_2_hours
                  state: "on"
                - alias: "Make sure boiler is not off at cheapest hour if 2 most expensive hours are consecutive"
                  condition: state
                  entity_id: binary_sensor.next_hour_is_more_expensive
                  state: "off"
              sequence:
                - service: switch.turn_off
                  entity_id: switch.boiler
          default:
            - service: switch.turn_on
              entity_id: switch.boiler