central_cooling_package:
  climate:
    - platform: generic_thermostat
      name: Master thermostat (cooling)
      heater: input_boolean.cooling_active
      ac_mode: true
      target_sensor: sensor.master_temperature_maximum
      min_temp: 18
      max_temp: 28
      cold_tolerance: 0.2
      hot_tolerance: 0.4
      min_cycle_duration:
        hours: 1
      precision: 0.1

  input_boolean:
    cooling_active:
      name: Cooling active
      icon: mdi:heating-coil

  input_number:
    heat_pump_cooling_temperature_threshold:
      name: "Heat pump cooling temperature threshold"
      icon: mdi:thermometer-high
      min: 22
      max: 35
      mode: box
      step: 1
      unit_of_measurement: "°C"
    thermostat_temperature_cooling_setpoint:
      name: "Thermostat temperature cooling setpoint"
      icon: mdi:thermometer-auto
      min: 15
      max: 25
      mode: box
      step: 0.5
      unit_of_measurement: "°C"
    thermostat_temperature_cooling_variance:
      name: "Thermostat temperature cooling variance"
      icon: mdi:thermometer-plus
      min: 0
      max: 2
      mode: box
      step: 0.5
      unit_of_measurement: "°C"
    water_temperature_cooling_setpoint:
      name: "Water temperature cooling setpoint"
      icon: mdi:thermometer-water
      min: 15
      max: 25
      mode: box
      step: 0.5
      unit_of_measurement: "°C"
    water_temperature_cooling_variance:
      name: "Water temperature cooling variance"
      icon: mdi:thermometer-plus
      min: 0
      max: 10
      mode: box
      step: 0.5
      unit_of_measurement: "°C"

  switch:
    - platform: template
      switches:
        heat_pump_cooling:
          friendly_name: "Heat pump cooling"
          unique_id: a5f70c08-1e90-4152-8921-f3fb29890f78
          value_template: "{{ is_state('switch.mitsubishi_system_on_off', 'on') and is_state('switch.mitsubishi_set_holiday_mode', 'off') and is_state('select.mitsubishi_hc_control_type', 'Cooling') }}"
          availability_template: "{{ True }}"
          icon_template: "{{ 'mdi:heat-pump' if this.state == 'on' else 'mdi:heat-pump-outline' }}"
          turn_on:
            - service: switch.turn_on
              target:
                entity_id: switch.mitsubishi_system_on_off
            - service: select.select_option
              target:
                entity_id: select.mitsubishi_hc_control_type
              data:
                option: Cooling
            - service: switch.turn_off
              target:
                entity_id: switch.mitsubishi_set_holiday_mode
          turn_off:
            - service: switch.turn_on
              target:
                entity_id: switch.mitsubishi_set_holiday_mode

  sensor:
    - platform: average
      name: average_minimum_indoor_temperature_last_week
      duration:
        hours: 168
      entities: sensor.master_temperature_minimum
    - platform: min_max
      unique_id: 432fff0d-b250-41d1-acef-54b4d471c005
      name: Master temperature maximum
      type: max
      round_digits: 1
      entity_ids:
        - sensor.master_temperature
        - sensor.living_room_temperature
    - platform: min_max
      unique_id: 01a51a5c-26d8-4ecb-9574-63f0c464561c
      name: Highest dew point
      type: max
      entity_ids:
        - sensor.bedroom_dew_point
        - sensor.ellen_s_room_dew_point
        - sensor.kitchen_dew_point
        - sensor.living_room_dew_point
        - sensor.office_dew_point
    - platform: nordpool_diff
      nordpool_entity: sensor.day_ahead_price
      filter_length: 20
      filter_type: rectangle
      normalize: max_min

  template:
    - trigger:
        - platform: time
          at: "00:00:00"
      action:
        - service: weather.get_forecasts
          data:
            type: hourly
          target:
            entity_id: weather.combined
          response_variable: forecast_hourly
      binary_sensor:
        - name: "Heat pump cooling today"
          device_class: heat
          state: >
            {% set forecast_values = forecast_hourly['weather.combined'] %}
            {% set forecast_list = forecast_values.forecast[0:24] %}
            {% set max_temp_forecast = forecast_list | map(attribute='temperature') | list | max %}
            {% set threshold = states('input_number.heat_pump_cooling_temperature_threshold') | float(30) %}
            {{ max_temp_forecast >= threshold
              or (threshold - max_temp_forecast < 6 and states('sensor.average_minimum_indoor_temperature_last_week') | float(0) >= 22.4)
              or (threshold - max_temp_forecast < 9 and states('sensor.average_minimum_indoor_temperature_last_week') | float(0) >= 22.8) }}
          attributes:
            debug_list: "{{ forecast_hourly }}"

  automation:
    - alias: "Heat pump: Set thermostat temperature (cooling)"
      id: 7ce66f5a-0ad0-40d1-b6bd-a9bd7e9a37b8
      mode: queued
      trigger:
        - platform: state
          entity_id: sensor.nordpool_diff_rectangle_20_normalize_max_min
          for:
            seconds: 1
      condition:
        - condition: state
          entity_id: select.mitsubishi_hc_control_type
          state: "Cooling"
        - "{{ has_value('sensor.day_ahead_price') }}"
      action:
        - service: climate.set_temperature
          target:
            entity_id: climate.master_thermostat_cooling
          data:
            temperature: >
              {% set temp_setpoint = states('input_number.thermostat_temperature_cooling_setpoint') | float(22.5) %}
              {% set variance = states('input_number.thermostat_temperature_cooling_variance') | float(0.5) %}
              {% set temperature_offset = -0.2 if today_at("11:00") < now() < today_at("17:30") else 0.3 %}
              {{ (temp_setpoint + temperature_offset - states('sensor.nordpool_diff_rectangle_20_normalize_max_min') | float(0) * variance) | round(1) if is_state('binary_sensor.negative_electricity_price_this_hour', 'off') else 21 }}

    - alias: "Heat pump: Set flow temperature (cooling)"
      id: 2bab2b81-620d-40dc-bf4f-24b532e6e4fb
      mode: single
      max_exceeded: silent
      trigger:
        - platform: state
          entity_id: sensor.nordpool_diff_rectangle_20_normalize_max_min
          for:
            seconds: 1
        - platform: state
          entity_id: sensor.highest_dew_point
          for:
            seconds: 1
      condition:
        - condition: state
          entity_id: select.mitsubishi_hc_control_type
          state: "Cooling"
      action:
        - service: number.set_value
          target:
            entity_id: number.mitsubishi_h_c_thermostat_target_temperature
          data:
            value: >
              {% set temp_setpoint = states('input_number.water_temperature_cooling_setpoint') | float(20) %}
              {% set variance = states('input_number.water_temperature_cooling_variance') | float(3) %}
              {% set dynamic_temp = 17 if is_state('binary_sensor.negative_electricity_price_this_hour', 'on') else (temp_setpoint - states('sensor.nordpool_diff_rectangle_20_normalize_max_min') | float(0) * variance) %}
              {% set dewpoint_temp = states('sensor.highest_dew_point') | float + 1 %}
              {{ min(20.5, max(dynamic_temp, dewpoint_temp)) | round(1, 'half') }}
        - delay: "00:05:00"

    - alias: "Heat pump: Toggle cooling"
      id: 90b21a58-76d3-4cb2-bbec-29ea7a0a8ac7
      mode: queued
      trigger:
        - platform: state
          entity_id: input_boolean.cooling_active
        - platform: state
          entity_id: binary_sensor.negative_electricity_price_this_hour
      condition:
        - condition: state
          entity_id: select.mitsubishi_hc_control_type
          state: "Cooling"
      action:
        - choose:
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.average_minimum_indoor_temperature_last_week
                  below: 23
                - condition: state
                  entity_id: input_boolean.vacation_mode
                  state: "on"
                - condition: state
                  entity_id: input_boolean.vacation_mode_coming_home
                  state: "off"
                - condition: state
                  entity_id: binary_sensor.negative_electricity_price_this_hour
                  state: "off"
              sequence:
                - service: switch.turn_off
                  data:
                    entity_id: switch.heat_pump_cooling
            - conditions:
                - condition: state
                  entity_id: input_boolean.cooling_active
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.heat_pump_cooling_today
                  state: "on"
              sequence:
                - service: switch.turn_on
                  data:
                    entity_id: switch.heat_pump_cooling
            - conditions:
                - condition: state
                  entity_id: binary_sensor.negative_electricity_price_this_hour
                  state: "on"
                - condition: numeric_state
                  entity_id: sensor.average_minimum_indoor_temperature_last_week
                  above: 21
              sequence:
                - service: switch.turn_on
                  data:
                    entity_id: switch.heat_pump_cooling
          default:
            - service: switch.turn_off
              data:
                entity_id: switch.heat_pump_cooling

    - alias: "Heat pump: Toggle cooling/heating"
      id: 09309dd7-a972-49c8-95da-0d98fa8aadcb
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.heat_pump_cooling_today
          to: "on"
          id: ask_to_switch_to_cooling
        - platform: numeric_state
          entity_id: sensor.average_minimum_indoor_temperature_last_week
          above: 22.0
          for: "01:00:00"
          id: ask_to_switch_to_cooling
        - platform: numeric_state
          entity_id: sensor.average_minimum_indoor_temperature_last_24_hours
          below: 21.5
          for: "01:00:00"
          id: ask_to_switch_to_heating
        - platform: state
          entity_id: sensor.season
          to: "winter"
          id: ask_to_switch_to_heating
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            action: "switch_to_cooling"
          id: switch_to_cooling
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            action: "switch_to_heating"
          id: switch_to_heating
      action:
        - choose:
          - conditions:
              - "{{ trigger.id == 'ask_to_switch_to_cooling' }}"
              - condition: state
                entity_id: select.mitsubishi_hc_control_type
                state: "Heating"
            sequence:
              - service: notify.sicco_phone
                data:
                  title: "Heat pump switch mode"
                  message: "Do you want to switch to Cooling mode?"
                  data:
                    tag: heat_pump_mode_switch
                    channel: "Heat pump"
                    importance: max
                    notification_icon: "mdi:wave-arrow-down"
                    actions:
                      - action: "switch_to_cooling"
                        title: "Switch to Cooling"
          - conditions:
              - "{{ trigger.id == 'ask_to_switch_to_heating' }}"
              - condition: state
                entity_id: select.mitsubishi_hc_control_type
                state: "Cooling"
            sequence:
              - service: notify.sicco_phone
                data:
                  title: "Heat pump switch mode"
                  message: "Do you want to switch to Heating mode?"
                  data:
                    tag: heat_pump_mode_switch
                    channel: "Heat pump"
                    importance: max
                    notification_icon: "mdi:wave-arrow-down"
                    actions:
                      - action: "switch_to_heating"
                        title: "Switch to Heating"
          - conditions:
              - "{{ trigger.id == 'switch_to_cooling' }}"
              - condition: state
                entity_id: select.mitsubishi_hc_control_type
                state: "Heating"
            sequence:
              - service: select.select_option
                target:
                  entity_id: select.mitsubishi_a_c_mode
                data:
                  option: Cooling flow
              - service: notify.sicco_phone
                data:
                  title: "Heat pump switch mode"
                  message: "Switched to Cooling. Don't forget to change the termostats."
                  data:
                    tag: heat_pump_mode_switch
                    channel: "Heat pump"
                    importance: max
                    notification_icon: "mdi:wave-arrow-down"
          - conditions:
              - "{{ trigger.id == 'switch_to_heating' }}"
              - condition: state
                entity_id: select.mitsubishi_hc_control_type
                state: "Cooling"
            sequence:
              - service: select.select_option
                target:
                  entity_id: select.mitsubishi_a_c_mode
                data:
                  option: Heating flow
              - service: notify.sicco_phone
                data:
                  title: "Heat pump switch mode"
                  message: "Switched to Heating. Don't forget to change the termostats."
                  data:
                    tag: heat_pump_mode_switch
                    channel: "Heat pump"
                    importance: max
                    notification_icon: "mdi:wave-arrow-down"
