living_room_lights_package:
  adaptive_lighting:
  - name: "Living Room"
    lights:
      - light.living_room_ceiling
      - light.living_room_corner
    min_brightness: 55
    max_brightness: 100
    autoreset_control_seconds: 10800
    detect_non_ha_changes: true

  binary_sensor:
    - platform: threshold
      name: Living Room is dark
      entity_id: sensor.living_room_motion_sensor_illuminance_lux
      lower: 140
      hysteresis: 90

  input_boolean:
    automatic_living_room_lights:
      name: Automatic living room lights
      icon: mdi:lightbulb-auto
    living_room_lights_manually_switched_on:
      name: Living room lights manually switched on
      icon: mdi:light-switch

  input_number:
    living_room_lights_time_on:
      name: Living room lights time on
      icon: mdi:clock-start
      min: 1
      max: 30
      mode: box

  light:
    - platform: group
      unique_id: 1c9797f1-17e2-4bab-96e9-8c92e2b5a903
      name: "Living Room Ceiling"
      entities:
        - light.living_room_ceiling_1
        - light.living_room_ceiling_2
        - light.living_room_ceiling_3

  template:
    - binary_sensor:
        - name: "Activity in living room"
          unique_id: activity_in_living_room
          state: >
            {{ is_state("binary_sensor.living_room_motion_sensor_occupancy", "on") 
              or is_state('media_player.65oled807_12_2', 'on') }}

  automation:
    - alias: "Living Room: Toggle lights"
      id: 309f2058-d8bb-4fbd-ae1e-3229071a01dc
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.activity_in_living_room
        - platform: state
          entity_id: binary_sensor.activity_in_living_room
          to: "off"
          for:
            minutes: >
              {% set extra_time = 30 if is_state('input_boolean.living_room_lights_manually_switched_on', 'on') else 0 %}
              {{ states('input_number.living_room_lights_time_on')|int(1) + extra_time }}
        - platform: state
          entity_id: binary_sensor.living_room_is_dark
        - platform: state
          entity_id: binary_sensor.sun_low_elevation
        - platform: state
          entity_id: input_boolean.automatic_living_room_lights
          to: "on"
      condition:
        - condition: state
          entity_id: input_boolean.automatic_living_room_lights
          state: "on"
      action:
        - choose:
            # Turn on light if there's activity and sun is low or it is dark
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_living_room
                  state: "on"
                - or:
                  - condition: state
                    entity_id: binary_sensor.sun_low_elevation
                    state: "on"
                  - condition: state
                    entity_id: binary_sensor.living_room_is_dark
                    state: "on"
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.living_room_ceiling
            # Turn off lights when there's no activity
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_living_room
                  state: "off"
                  for:
                    minutes: >
                      {% set extra_time = 30 if is_state('input_boolean.living_room_lights_manually_switched_on', 'on') else 0 %}
                      {{ states('input_number.living_room_lights_time_on')|int(1) + extra_time }}
              sequence:
                - service: light.turn_off
                  data:
                    entity_id: light.living_room_ceiling
            # Turn off lights when it's not dark anymore
            - conditions:
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "off"
                - condition: state
                  entity_id: binary_sensor.living_room_is_dark
                  state: "off"
              sequence:
                - service: light.turn_off
                  data:
                    entity_id: light.living_room_ceiling

    - alias: "Living Room: Light switch"
      id: 431f7145-6b90-4343-a4e2-a07f105bfb46
      description: ''
      use_blueprint:
        path: vandalon/z2m EnOcean PTM 215Z (Friends of Hue) switch.yaml
        input:
          controller: Living Room Switch
          button_1_pressed:
          - service: light.turn_on
            data: {}
            target:
              entity_id: light.living_room_ceiling
          button_1_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: "{\"brightness_move_onoff\": 51}"
                qos: 0
                retain: false
          button_1_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_2_pressed:
          - service: light.turn_off
            data: {}
            target:
              entity_id: light.living_room_ceiling
          button_2_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: "{\"brightness_move_onoff\": -51}"
                qos: 0
                retain: false
          button_2_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_3_pressed:
          - service: light.turn_on
            data: {}
            target:
              entity_id: light.living_room_corner
          button_3_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: "{\"brightness_move_onoff\": 51}"
                qos: 0
                retain: false
          button_3_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_4_pressed:
          - service: light.turn_off
            data: {}
            target:
              entity_id: light.living_room_corner
          button_4_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: "{\"brightness_move_onoff\": -51}"
                qos: 0
                retain: false
          button_4_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_1_and_3_pressed:
          - service: light.turn_on
            data: {}
            target:
              entity_id:
                - light.living_room_ceiling
                - light.living_room_corner
          button_2_and_4_pressed:
          - service: light.turn_off
            data: {}
            target:
              entity_id:
                - light.living_room_ceiling
                - light.living_room_corner

    # ##### Vacation lighting
    # - alias: 'Vacation: Replay lighting in living room from 7 days ago'
    #   id: 3da83415-9e36-402d-bf97-28947375910c
    #   mode: queued
    #   trigger:
    #     - platform: state
    #       entity_id: sensor.replay_living_room_ceiling
    #     - platform: state
    #       entity_id: sensor.replay_living_room_stand
    #     - platform: state
    #       entity_id: sensor.replay_living_room_table
    #     - platform: state
    #       entity_id: sensor.replay_living_room_reading_lamp
    #   condition:
    #     - condition: or
    #       conditions:
    #       - condition: state
    #         entity_id: input_boolean.vacation_mode
    #         state: 'on'
    #       - condition: state
    #         entity_id: input_boolean.vacation_mode_short_trip
    #         state: 'on'
    #     - condition: state
    #       entity_id: binary_sensor.motion_in_living_room
    #       state: "off"
    #   action:
    #     - variables:
    #         corresponding_light: >
    #           {% if trigger.entity_id == 'sensor.replay_living_room_ceiling' %}
    #             {{ 'light.living_room_ceiling' }}
    #           {% elif trigger.entity_id == 'sensor.replay_living_room_stand' %}
    #             {{ 'light.living_room_stand' }}
    #           {% elif trigger.entity_id == 'sensor.replay_living_room_table' %}
    #             {{ 'light.living_room_table' }}
    #           {% elif trigger.entity_id == 'sensor.replay_living_room_reading_lamp' %}
    #             {{ 'light.living_room_reading_lamp' }}
    #           {% endif %}
    #     - choose:
    #         # Replay turned on && entity_id is "LIGHT"
    #         - conditions:
    #             condition: and
    #             conditions: 
    #               - condition: template
    #                 value_template: '{{ trigger.to_state.state  == "1" }}'
    #               - condition: template
    #                 value_template: '{{ corresponding_light.split(".")[0] == "light" }}'
    #           sequence:
    #             - service: light.turn_on
    #               data:
    #                 entity_id: '{{ corresponding_light }}'
    #             - service: system_log.write
    #               data:
    #                 message: 'Vacation - Replay Lighting (Living Room): {{trigger.to_state.entity_id}}: turning on: {{ corresponding_light }}'
    #                 level: info

    #         # Replay turned on && entity_id is "SWITCH"
    #         - conditions:
    #             condition: and
    #             conditions: 
    #               - condition: template
    #                 value_template: '{{ trigger.to_state.state == "1" }}'
    #               - condition: template
    #                 value_template: '{{ corresponding_light.split(".")[0] == "switch" }}'
    #           sequence:
    #             - service: switch.turn_on
    #               data:
    #                 entity_id: '{{ corresponding_light }}'
    #             - service: system_log.write
    #               data:
    #                 message: 'Vacation - Replay Lighting (Living Room): {{trigger.to_state.entity_id}}: turning on:{{ corresponding_light }}'
    #                 level: info

    #         # Replay turned off
    #         - conditions:
    #             condition: and
    #             conditions: 
    #               - condition: template
    #                 value_template: '{{ trigger.to_state.state == "0" }}'
    #           sequence:
    #             - service: homeassistant.turn_off
    #               data:
    #                 entity_id: '{{ corresponding_light }}'
    #             - service: system_log.write
    #               data:
    #                 message: 'Vacation - Replay Lighting (Living Room): {{trigger.to_state.entity_id}}: turning off:{{ corresponding_light }}'
    #                 level: info