living_room_lights_package:
  adaptive_lighting:
    - name: "Living Room"
      lights:
        - light.living_room_ceiling
      min_brightness: 70
      max_brightness: 100
      autoreset_control_seconds: 14400
      detect_non_ha_changes: true
      sunset_offset: 1800
      skip_redundant_commands: true
    - name: "Living Room Cozy"
      lights:
        - light.living_room_cozy
      min_brightness: 40
      max_brightness: 100
      autoreset_control_seconds: 14400
      detect_non_ha_changes: true
      sunset_offset: 1800
      skip_redundant_commands: true
    - name: "Living Room TV Wall"
      lights:
        - light.living_room_tv_wall_lamps
      min_brightness: 30
      max_brightness: 70
      autoreset_control_seconds: 14400
      detect_non_ha_changes: true
      sunset_offset: 1800
      skip_redundant_commands: true

  binary_sensor:
    - platform: threshold
      name: Living Room is dark
      entity_id: sensor.living_room_motion_sensor_illuminance
      lower: 140
      hysteresis: 140

  input_boolean:
    automatic_living_room_lights:
      name: Automatic living room lights
      icon: mdi:lightbulb-auto
    living_room_lights_manually_switched_on:
      name: Living room lights manually switched on
      icon: mdi:light-switch
    living_room_lights_manual_brightness:
      name: Living room lights manual brightness
      icon: mdi:light-switch
    living_room_movie_mode:
      name: Living room movie mode
      icon: mdi:movie-play

  input_number:
    living_room_lights_time_on:
      name: Living room lights time on
      icon: mdi:clock-start
      min: 1
      max: 60
      mode: box

  template:
    - binary_sensor:
        - name: "Activity in living room"
          unique_id: activity_in_living_room
          device_class: occupancy
          state: >
            {{ is_state("binary_sensor.living_room_motion_sensor_occupancy", "on") 
              or not is_state('media_player.philips_65oled807', 'off') }}

  script:
    handle_turn_on_living_room_lights:
      alias: "Living Room: Handle turn on lights"
      icon: mdi:lamps
      mode: queued
      sequence:
        - if:
            - condition: state
              entity_id: input_boolean.automatic_living_room_lights
              state: "off"
          then:
            - stop: "Automatic lights are switched off, lights won't be adjusted"
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.living_room_lights_manual_brightness
                  state: "on"
              sequence:
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: true
                    entity_id: switch.adaptive_lighting_living_room
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: true
                    entity_id: switch.adaptive_lighting_living_room_cozy
            - conditions:
                - condition: time
                  after: "20:00:00"
                  before: "04:00:00"
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "on"
                - condition: state
                  entity_id: input_boolean.living_room_movie_mode
                  state: "on"
              sequence:
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: true
                    entity_id: switch.adaptive_lighting_living_room
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: true
                    entity_id: switch.adaptive_lighting_living_room_cozy
                - service: scene.turn_on
                  target:
                    entity_id: scene.living_room_lights_2_movie
                  data:
                    transition: 3
            - conditions:
                - condition: time
                  after: "20:00:00"
                  before: "04:00:00"
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "on"
                - not:
                    - condition: state
                      entity_id: media_player.philips_65oled807
                      state: "off"
              sequence:
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: true
                    entity_id: switch.adaptive_lighting_living_room
                    lights:
                      - light.living_room_ceiling
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: true
                    entity_id: switch.adaptive_lighting_living_room_cozy
                - service: scene.turn_on
                  target:
                    entity_id: scene.living_room_lights_0_tv
                  data:
                    transition: 3
                - service: input_boolean.turn_on
                  entity_id: input_boolean.automatic_living_room_lights
            - conditions:
                - condition: time
                  before: "20:00:00"
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "off"
              sequence:
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: false
                    entity_id: switch.adaptive_lighting_living_room
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: false
                    entity_id: switch.adaptive_lighting_living_room_cozy
                - service: light.turn_on
                  target:
                    entity_id:
                      - light.living_room_ceiling
                - if:
                    - condition: state
                      entity_id: cover.living_room_roller_shade_big
                      state: "closed"
                  then:
                    - service: light.turn_on
                      target:
                        entity_id:
                          - light.living_room_corner
            - conditions:
                - condition: time
                  after: "20:00:00"
                  before: "04:00:00"
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "on"
                - "{{ state_attr('switch.adaptive_lighting_living_room', 'sun_position') | float(0) < -0.3 }}"
              sequence:
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: false
                    entity_id: switch.adaptive_lighting_living_room
                - service: adaptive_lighting.set_manual_control
                  data:
                    manual_control: false
                    entity_id: switch.adaptive_lighting_living_room_cozy
                - if:
                    - condition: state
                      entity_id: light.living_room_cozy
                      state: "off"
                  then:
                    - service: scene.turn_on
                      target:
                        entity_id: scene.living_room_lights_1_cozy
                      data:
                        transition: 3
                - service: input_boolean.turn_on
                  entity_id: input_boolean.automatic_living_room_lights
          default:
            - service: light.turn_on
              target:
                entity_id:
                  - light.living_room_ceiling
                  - light.living_room_corner
        - delay: "00:00:05"

  automation:
    - alias: "Living Room: Toggle lights"
      id: 309f2058-d8bb-4fbd-ae1e-3229071a01dc
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.activity_in_living_room
        - platform: state
          entity_id: binary_sensor.activity_in_living_room
          to: "off"
          for:
            minutes: >
              {% set extra_time = 30 if is_state('input_boolean.living_room_lights_manually_switched_on', 'on') else 0 %}
              {{ states('input_number.living_room_lights_time_on')|int(1) + extra_time }}
        - platform: state
          entity_id: binary_sensor.living_room_is_dark
        - platform: state
          entity_id: media_player.philips_65oled807
        - platform: state
          entity_id: binary_sensor.sun_low_elevation
        - platform: state
          entity_id: input_boolean.automatic_living_room_lights
          to: "on"
      condition:
        - condition: state
          entity_id: input_boolean.automatic_living_room_lights
          state: "on"
      action:
        - choose:
            # Turn on light if there's activity and sun is low
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_living_room
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "on"
              sequence:
                - service: script.turn_on
                  entity_id: script.handle_turn_on_living_room_lights
                # - service: light.turn_on
                #   data:
                #     entity_id:
                #       - light.living_room_ceiling
                #       - light.living_room_corner
            # Turn on light if there's activity and it is dark
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_living_room
                  state: "on"
                - condition: state
                  entity_id: binary_sensor.living_room_is_dark
                  state: "on"
              sequence:
                - service: script.turn_on
                  entity_id: script.handle_turn_on_living_room_lights
                # - service: light.turn_on
                #   data:
                #     entity_id: light.living_room_ceiling
            - conditions:
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "on"
                - condition: state
                  entity_id: input_boolean.sleep_mode
                  state: "off"
                - condition: time
                  after: "19:00:00"
                  before: "01:00:00"
              sequence:
                - service: script.turn_on
                  entity_id: script.handle_turn_on_living_room_lights
                # - service: light.turn_on
                #   data:
                #     entity_id: light.living_room_ceiling
            # Turn off lights when there's no activity
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_living_room
                  state: "off"
                  for:
                    minutes: >
                      {% set extra_time = 30 if is_state('input_boolean.living_room_lights_manually_switched_on', 'on') else 0 %}
                      {{ states('input_number.living_room_lights_time_on')|int(1) + extra_time }}
              sequence:
                - service: light.turn_off
                  data:
                    entity_id:
                      - light.living_room_lights
            # Turn off lights when it's not dark anymore
            - conditions:
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "off"
                - condition: state
                  entity_id: binary_sensor.living_room_is_dark
                  state: "off"
              sequence:
                - service: light.turn_off
                  data:
                    entity_id:
                      - light.living_room_lights

    - alias: "Living Room: Light switch"
      id: 431f7145-6b90-4343-a4e2-a07f105bfb46
      description: ""
      use_blueprint:
        path: chris-1243/PTM_215Z_ZE.yaml
        input:
          hold_delay: 300
          controller: Living Room Switch
          button_1_pressed:
            - service: light.turn_on
              data: {}
              target:
                entity_id: light.living_room_ceiling
          button_1_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move_onoff": 85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_lights_manual_brightness
          button_1_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_2_pressed:
            - service: light.turn_off
              data: {}
              target:
                entity_id: light.living_room_ceiling
          button_2_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move_onoff": -85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_lights_manual_brightness
          button_2_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_3_pressed:
            - service: light.turn_on
              data: {}
              target:
                entity_id: light.living_room_corner
          button_3_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move_onoff": 85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_lights_manual_brightness
          button_3_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_4_pressed:
            - service: light.turn_off
              data: {}
              target:
                entity_id: light.living_room_corner
          button_4_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move_onoff": -85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_lights_manual_brightness
          button_4_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_1_and_3_pressed:
            - service: light.turn_on
              data: {}
              target:
                entity_id:
                  - light.living_room_lights
          button_1_and_3_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move_onoff": 85}'
                qos: 0
                retain: false
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move_onoff": 85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_lights_manual_brightness
          button_1_and_3_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
          button_2_and_4_pressed:
            - service: light.turn_off
              data: {}
              target:
                entity_id:
                  - light.living_room_lights
          button_2_and_4_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move_onoff": -85}'
                qos: 0
                retain: false
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move_onoff": -85}'
                qos: 0
                retain: false
            - service: input_boolean.turn_on
              entity_id: input_boolean.living_room_lights_manual_brightness
          button_2_and_4_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Ceiling/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Living Room Corner/set
                payload: '{"brightness_move": "stop"}'
                qos: 0
                retain: false

    - alias: "Living Room: Toggle automatic lights"
      mode: single
      trigger:
        - platform: state
          entity_id:
            - light.living_room_bookcase
            - light.living_room_ceiling
            - light.living_room_corner
            - light.living_room_standing_lamp
      condition:
        - condition: template
          value_template: >
            {{ trigger.to_state.context.user_id != None
              and not trigger.to_state.context.parent_id }}
      action:
        - service: input_boolean.turn_off
          entity_id: input_boolean.automatic_living_room_lights
        # - service: notify.persistent_notification
        #   metadata: {}
        #   data:
        #     message: Lights toggled by user {{ trigger.to_state.context.user_id }} with parent_id {{ trigger.to_state.context.parent_id }}
        # - delay:
        #     seconds: 10

    - alias: "Light: Reset manual brightness living room"
      id: 72599b3f-4173-413c-a04d-af31a5d6d73d
      trigger:
        - platform: state
          entity_id:
            - input_boolean.living_room_lights_manual_brightness
          to: "on"
          for:
            hours: 8
      action:
        - service: input_boolean.turn_off
          data:
            entity_id: "{{ trigger.to_state.entity_id }}"

    - alias: "Light: Reset movie mode"
      id: 1298faa0-0ea7-414d-b06f-50bcbb9823a2
      trigger:
        - platform: state
          entity_id:
            - media_player.philips_65oled807
          to: "off"
          for:
            seconds: 10
      action:
        - service: input_boolean.turn_off
          data:
            entity_id: input_boolean.living_room_movie_mode

    # - alias: "Living Room: Dimmer Switch"
    #   id: cc123c50-4838-4300-8a53-d184daa28403
    #   mode: queued
    #   trigger:
    #     - platform: state
    #       entity_id: sensor.living_room_dimmer_switch_action
    #   action:
    #     # on_press (always)
    #     # on_press_release (immediate release)
    #     # on_hold (hold)
    #     # on_hold_release (release after hold)
    #     # up_...
    #     # down_...
    #     # off_...
    #     - choose:
    #         - conditions:
    #             - "{{ trigger.to_state.state == 'on_press' }}"
    #           sequence:
    #             - if:
    #                 - condition: state
    #                   entity_id: light.living_room_lights
    #                   state: "off"
    #               then:
    #                 - service: script.turn_on
    #                   entity_id: script.handle_turn_on_living_room_lights
    #               else:
    #                 - service: light.turn_off
    #                   target:
    #                     entity_id: light.living_room_lights
    #         - conditions:
    #             - "{{ trigger.to_state.state == 'off' }}"
    #           sequence:
    #             - service: light.turn_off
    #               target:
    #                 entity_id: light.bedroom_lights
    #         - conditions:
    #             - "{{ trigger.to_state.state == 'brightness_move_up' }}"
    #           sequence:
    #             - service: mqtt.publish
    #               data:
    #                 topic: zigbee2mqtt/Bedroom Ceiling/set
    #                 payload: "{\"brightness_move_onoff\": 85}"
    #                 qos: 0
    #                 retain: false
    #             - service: mqtt.publish
    #               data:
    #                 topic: zigbee2mqtt/Bed Headboard/set
    #                 payload: "{\"brightness_move_onoff\": 85}"
    #                 qos: 0
    #                 retain: false
    #         - conditions:
    #             - "{{ trigger.to_state.state == 'brightness_move_down' }}"
    #           sequence:
    #             - service: mqtt.publish
    #               data:
    #                 topic: zigbee2mqtt/Bedroom Ceiling/set
    #                 payload: "{\"brightness_move_onoff\": -85}"
    #                 qos: 0
    #                 retain: false
    #             - service: mqtt.publish
    #               data:
    #                 topic: zigbee2mqtt/Bed Headboard/set
    #                 payload: "{\"brightness_move_onoff\": -85}"
    #                 qos: 0
    #                 retain: false
    #         - conditions:
    #             - "{{ trigger.to_state.state == 'brightness_stop' }}"
    #           sequence:
    #             - service: mqtt.publish
    #               data:
    #                 topic: zigbee2mqtt/Bedroom Ceiling/set
    #                 payload: "{\"brightness_move\": \"stop\"}"
    #                 qos: 0
    #                 retain: false
    #             - service: mqtt.publish
    #               data:
    #                 topic: zigbee2mqtt/Bed Headboard/set
    #                 payload: "{\"brightness_move\": \"stop\"}"
    #                 qos: 0
    #                 retain: false
