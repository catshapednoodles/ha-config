living_room_media_players_package:
  powercalc:
    sensors:
    - create_group: Living room media devices
      entities:
        - entity_id: media_player.shield
          standby_power: 1.9
          fixed:
            states_power:
              playing: 6.9
              paused: 6.9
              idle: 3.2
              standby: 3.2
        - entity_id: media_player.yamaha_receiver
          standby_power: 0.1
          fixed:
            power: 20
            states_power:
              playing: 40
        - entity_id: switch.subwoofer
          power_sensor_id: sensor.subwoofer_power
          energy_sensor_id: sensor.subwoofer_energy

  media_player:
    - platform: yamaha
      host: !secret yamaha_receiver_host
      source_names:
        HDMI1: NVIDIA Shield TV
        HDMI2: Nintendo Switch
        AUDIO1: TV
      source_ignore:
        - "AUDIO2"
        - "AUDIO3"
        - "AUX"
        - "AV1"
        - "AV2"
        - "AV3"
        - "Alexa"
        - "Amazon Music"
        - "Deezer"
        - "MusicCast Link"
        - "NET RADIO"
        - "Napster"
        - "Qobuz"
        - "TIDAL"
        - "TUNER"

  automation:
    - alias: "Media player: Toggle extra bass on receiver"
      id: 344f6a66-dca9-4369-b75b-759634913b8d
      trigger:
      - entity_id: media_player.yamaha_receiver
        platform: state
        attribute: source
        to: "Spotify"
        id: extra_bass_off
      - entity_id: media_player.yamaha_receiver
        platform: state
        attribute: source
        from: "Spotify"
        id: extra_bass_on
      action:
      - choose:
        - conditions:
          - condition: trigger
            id: extra_bass_on
          sequence:
          - service: switch.turn_on
            entity_id: switch.extra_bass
        - conditions:
          - condition: trigger
            id: extra_bass_off
          sequence:
          - service: switch.turn_off
            entity_id: switch.extra_bass

    - alias: "Media player: Sync receiver and subwoofer"
      trigger: 
      - entity_id: media_player.yamaha_receiver
        platform: state
        to: "on"
        id: receiver_on
      - entity_id: media_player.yamaha_receiver
        platform: state
        to: "playing"
        id: receiver_on
      - entity_id: media_player.yamaha_receiver
        platform: state
        to: "off"
        id: receiver_off
      action:
      - choose:
        - conditions:
          - condition: trigger
            id: receiver_on
          sequence:
          - service: switch.turn_on
            entity_id: switch.subwoofer
        - conditions:
          - condition: trigger
            id: receiver_off
          sequence:
          - service: switch.turn_off
            entity_id: switch.subwoofer