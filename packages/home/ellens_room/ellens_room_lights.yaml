ellens_room_lights_package:
  adaptive_lighting:
    - name: "Ellen's Room"
      lights:
        - light.ellens_room_main
      min_brightness: 70
      max_brightness: 100
      autoreset_control_seconds: 10800
      detect_non_ha_changes: true

  binary_sensor:
    - platform: threshold
      name: Ellen's Room is dark
      entity_id: sensor.ellens_room_motion_sensor_illuminance_lux
      lower: 80
      hysteresis: 40

  input_boolean:
    automatic_ellens_room_lights:
      name: Automatic Ellen's Room lights
      icon: mdi:lightbulb-auto
    ellens_room_lights_manually_switched_on:
      name: Ellen's Room lights manually switched on
      icon: mdi:light-switch

  input_number:
    ellens_room_lights_time_on:
      name: Ellen's Room lights time on
      icon: mdi:clock-start
      min: 1
      max: 30
      mode: box

  template:
    - binary_sensor:
        - name: "Activity in Ellen's Room"
          unique_id: activity_in_ellen_s_room
          state: >
            {{ is_state("binary_sensor.ellens_room_motion_sensor_occupancy", "on") 
              or is_state('device_tracker.ellen_pc', 'home') }}

  automation:
    - alias: "Ellen's Room: Toggle lights"
      id: f5ddfc91-7ac2-48ac-adcc-539c82d8033a
      mode: queued
      trigger:
        - platform: state
          entity_id: binary_sensor.activity_in_ellen_s_room
        - platform: state
          entity_id: binary_sensor.activity_in_ellen_s_room
          to: "off"
          for:
            minutes: >
              {% set extra_time = 60 if is_state('input_boolean.ellens_room_lights_manually_switched_on', 'on') else 0 %}
              {{ states('input_number.ellens_room_lights_time_on')|int(1) + extra_time }}
        - platform: state
          entity_id: binary_sensor.ellen_s_room_is_dark
        - platform: state
          entity_id: binary_sensor.sun_low_elevation
        - platform: state
          entity_id: input_boolean.automatic_ellens_room_lights
          to: "on"
      condition:
        - condition: state
          entity_id: input_boolean.automatic_ellens_room_lights
          state: "on"
      action:
        - choose:
            # Turn on light if there's activity and sun is low or it is dark
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_ellen_s_room
                  state: "on"
                - or:
                  - condition: state
                    entity_id: binary_sensor.sun_low_elevation
                    state: "on"
                  - condition: state
                    entity_id: binary_sensor.ellen_s_room_is_dark
                    state: "on"
              sequence:
                - service: light.turn_on
                  data:
                    entity_id: light.ellens_room_main
            # Turn off lights when there's no activity
            - conditions:
                - condition: state
                  entity_id: binary_sensor.activity_in_ellen_s_room
                  state: "off"
                  for:
                    minutes: >
                      {% set extra_time = 60 if is_state('input_boolean.ellens_room_lights_manually_switched_on', 'on') else 0 %}
                      {{ states('input_number.ellens_room_lights_time_on')|int(1) + extra_time }}
              sequence:
                - service: light.turn_off
                  data:
                    entity_id: light.ellens_room_main
            # Turn off lights when it's not dark anymore
            - conditions:
                - condition: state
                  entity_id: binary_sensor.sun_low_elevation
                  state: "off"
                - condition: state
                  entity_id: binary_sensor.ellen_s_room_is_dark
                  state: "off"
              sequence:
                - service: light.turn_off
                  data:
                    entity_id: light.ellens_room_main

    - alias: "Ellen's Room: Light switch"
      id: 04b4e660-aaad-47ea-8b7e-21cb4de3df4b
      description: ''
      use_blueprint:
        path: vandalon/z2m EnOcean PTM 215Z (Friends of Hue) switch.yaml
        input:
          controller: Ellens Room Switch
          button_1_pressed:
          - service: light.turn_on
            data: {}
            target:
              entity_id: light.ellens_room_main
          button_1_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Main/set
                payload: "{\"brightness_move_onoff\": 51}"
                qos: 0
                retain: false
          button_1_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Main/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_2_pressed:
          - service: light.turn_off
            data: {}
            target:
              entity_id: light.ellens_room_main
          button_2_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Main/set
                payload: "{\"brightness_move_onoff\": -51}"
                qos: 0
                retain: false
          button_2_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Main/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_3_pressed:
          - service: light.turn_on
            data: {}
            target:
              entity_id: 
                - light.ellens_room_shelf
                - light.ellens_room_cotton_ball_string
          button_3_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Shelf/set
                payload: "{\"brightness_move_onoff\": 51}"
                qos: 0
                retain: false
          button_3_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Shelf/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_4_pressed:
          - service: light.turn_off
            data: {}
            target:
              entity_id: 
                - light.ellens_room_shelf
                - light.ellens_room_cotton_ball_string
          button_4_held:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Shelf/set
                payload: "{\"brightness_move_onoff\": -51}"
                qos: 0
                retain: false
          button_4_released:
            - service: mqtt.publish
              data:
                topic: zigbee2mqtt/Ellens Room Shelf/set
                payload: "{\"brightness_move\": \"stop\"}"
                qos: 0
                retain: false
          button_1_and_3_pressed:
          - service: light.turn_on
            data: {}
            target:
              entity_id:
                - light.ellens_room_main
                - light.ellens_room_shelf
                - light.ellens_room_cotton_ball_string
          button_2_and_4_pressed:
          - service: light.turn_off
            data: {}
            target:
              entity_id:
                - light.ellens_room_main
                - light.ellens_room_shelf
                - light.ellens_room_cotton_ball_string