front_door_lights_package:
  adaptive_lighting:
  - name: "Front door"
    lights:
      - light.front_door
      - light.backyard_light
    min_brightness: 40
    max_brightness: 100
    autoreset_control_seconds: 1800
    detect_non_ha_changes: true

  input_boolean:
    automatic_outside_lights:
      name: Automatic outside lights
      icon: mdi:lightbulb-auto

  template:
    - binary_sensor:
        - name: "Sun low elevation outside"
          unique_id: sun_low_elevation_outside
          state: >
            {% set cutoff = 2 %}
            {{ state_attr('sun.sun', 'elevation') < cutoff }}
          icon: "mdi:weather-sunset"

  automation:
    - alias: "Front Door: Turn on when sun is down"
      id: 680ccc85-de92-412a-a85a-3cea121e7b54
      trigger:
        - platform: state
          entity_id: binary_sensor.sun_low_elevation_outside
      condition:
        - condition: state
          entity_id: input_boolean.automatic_outside_lights
          state: "on"
      action:
        - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.sun_low_elevation_outside
                state: "on"
            sequence:
              - service: light.turn_on
                data: {}
                target:
                  entity_id: 
                    - light.front_door
                    - light.backyard_light
          - conditions:
              - condition: state
                entity_id: binary_sensor.sun_low_elevation_outside
                state: "off"
            sequence:
              - service: light.turn_off
                data: {}
                target:
                  entity_id: 
                    - light.front_door
                    - light.backyard_light

    - alias: "Front Door: More light when coming home"
      id: a44169ff-33a0-495c-8280-e484118eadf1
      trigger:
        - platform: state
          entity_id: device_tracker.iva_nce
          to: "home"
      condition:
        - condition: state
          entity_id: light.front_door
          state: "on"
      action:
        - service: light.turn_on
          data:
            brightness_pct: 100
            transition: 2
          target:
            entity_id: light.front_door
        - delay: "00:05:00"
        - service: adaptive_lighting.set_manual_control
          data:
            entity_id: switch.adaptive_lighting_front_door
            lights:
              - light.front_door
            manual_control: false